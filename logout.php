<?php
// logout.php (نسخه نهایی - بدون JWT)

/*
=====================================================
    NovelWorld - Logout Script
    Version: 3.0 (Cookie-Session Based, No JWT)
=====================================================
    - این اسکریپت وظیفه خروج کاربر از سیستم را با روش سشن مبتنی بر دیتابیس بر عهده دارد.
    - ابتدا رکورد سشن را از دیتابیس حذف می‌کند تا شناسه سشن باطل شود.
    - سپس کوکی مربوطه را از مرورگر کاربر پاک می‌کند.
*/

// --- گام ۱: فراخوانی فایل اتصال به دیتابیس ---
// ما برای حذف سشن از دیتابیس به این فایل نیاز داریم.
// این فایل باید دقیقاً با <?php شروع شود تا از خطاهای هدر جلوگیری کند.
require_once 'db_connect.php';

// --- گام ۲: بررسی وجود کوکی و حذف سشن از دیتابیس ---
if (isset($_COOKIE['user_session'])) {
    $session_id = $_COOKIE['user_session'];
    
    // تلاش برای حذف رکورد سشن از دیتابیس
    try {
        $stmt = $conn->prepare("DELETE FROM sessions WHERE session_id = ?");
        $stmt->execute([$session_id]);
    } catch (PDOException $e) {
        // در صورت بروز خطا، آن را لاگ می‌کنیم.
        // فرآیند خروج باید ادامه پیدا کند تا کوکی از مرورگر پاک شود.
        error_log("Logout DB Error: " . $e->getMessage());
    }

    // --- گام ۳: پاک کردن کوکی از مرورگر ---
    // این کار را صرف نظر از اینکه حذف از دیتابیس موفق بود یا نه، انجام می‌دهیم.
    // کوکی را با تنظیم تاریخ انقضا در گذشته، حذف می‌کنیم.
    unset($_COOKIE['user_session']); // از آرایه سراسری هم پاک می‌کنیم
    
    setcookie('user_session', '', [
        'expires' => time() - 3600, // یک ساعت در گذشته
        'path' => '/',
        'domain' => '',
        'secure' => true,
        'httponly' => true,
        'samesite' => 'Strict'
    ]);
}

// --- گام ۴: هدایت کاربر به صفحه اصلی ---
header("Location: index.php");

// --- گام ۵: پایان اجرای اسکریپت ---
exit();
