// db_connect.php

<?php
/*
=====================================================
    NovelWorld - Database Connection (Neon/PostgreSQL)
    Version: 2.0 (PDO & Serverless Ready)
=====================================================
    - این فایل برای اتصال به دیتابیس Neon (PostgreSQL) طراحی شده است.
    - از PDO برای اتصال استفاده می‌کند که مدرن‌تر و امن‌تر از MySQLi است.
    - اطلاعات اتصال از متغیرهای محیطی (Environment Variables) خوانده می‌شود
      تا از قرار دادن اطلاعات حساس در کد جلوگیری شود.
*/

// --- گام ۱: خواندن اطلاعات اتصال از متغیرهای محیطی ---
// این مقادیر را باید در بخش "Environment" در داشبورد Render خود تنظیم کنید.
// به این صورت که یک متغیر جدید با نام DB_HOST و مقدار مربوطه ایجاد می‌کنید.

$db_host = getenv('DB_HOST');
$db_name = getenv('DB_NAME');
$db_user = getenv('DB_USER');
$db_pass = getenv('DB_PASSWORD');

// بررسی می‌کنیم که آیا تمام متغیرها تنظیم شده‌اند یا نه
if (!$db_host || !$db_name || !$db_user || !$db_pass) {
    // در صورت عدم تنظیم، اجرای اسکریپت را با یک خطای واضح متوقف می‌کنیم.
    die("خطای پیکربندی: اطلاعات اتصال به دیتابیس در متغیرهای محیطی به درستی تنظیم نشده است.");
}


// --- گام ۲: ساخت رشته اتصال (DSN) برای PostgreSQL ---
// Neon برای اتصال امن به SSL/TLS نیاز دارد، بنابراین 'sslmode=require' ضروری است.
// DSN (Data Source Name) شامل تمام اطلاعات مورد نیاز برای اتصال است.
$dsn = "pgsql:host={$db_host};port=5432;dbname={$db_name};sslmode=require";


// --- گام ۳: ایجاد اتصال با استفاده از PDO در یک بلوک try-catch ---
try {
    // ایجاد یک نمونه جدید از کلاس PDO
    $conn = new PDO($dsn, $db_user, $db_pass, [
        // این گزینه به PDO می‌گوید که در صورت بروز خطا، یک Exception پرتاب کند.
        // این کار مدیریت خطاها را بسیار آسان‌تر و قابل اعتمادتر می‌کند.
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        
        // (اختیاری) این گزینه مشخص می‌کند که نتایج به صورت آرایه انجمنی (associative array) بازگردانده شوند.
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    ]);

    // اگر کد به این خط برسد، یعنی اتصال موفقیت‌آمیز بوده است.
    // متغیر $conn اکنون در تمام فایل‌هایی که این فایل را include کنند، در دسترس است.

} catch (PDOException $e) {
    // در صورت بروز خطا در اتصال، اجرای اسکریپت متوقف می‌شود و یک پیام خطای عمومی نمایش داده می‌شود.
    // در محیط واقعی (Production)، بهتر است جزئیات خطا را در یک فایل لاگ ذخیره کنید و به کاربر نمایش ندهید.
    // http_response_code(500); // ارسال کد خطای سرور
    die("خطا: اتصال به پایگاه داده با شکست مواجه شد. لطفاً بعداً تلاش کنید.");
    
    // برای دیباگ کردن در محیط توسعه، می‌توانید خط زیر را از کامنت خارج کنید:
    // die("خطای اتصال به دیتابیس: " . $e->getMessage());
}
?>
